<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Editor - CV Generator</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Profile Editor</h1>
            <p class="subtitle">Edit your candidate data and system prompt</p>
            <p class="candidate-name" th:text="'Current: ' + ${candidateName}">Current: Pranav Ghorpade</p>
        </header>

        <!-- Navigation -->
        <nav class="profile-nav">
            <a href="/" class="btn btn-small btn-secondary">Home</a>
            <a href="/history" class="btn btn-small btn-secondary">History</a>
        </nav>

        <!-- Tab Selector -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="candidate">Candidate Data (JSON)</button>
            <button class="tab-btn" data-tab="prompt">System Prompt</button>
        </div>

        <!-- Candidate Data Tab -->
        <section id="tab-candidate" class="tab-panel active">
            <div class="editor-card">
                <div class="editor-header">
                    <h2>candidate-data.json</h2>
                    <div class="editor-actions">
                        <button id="saveCandidateBtn" class="btn btn-primary btn-small">Save</button>
                        <button id="reloadCandidateBtn" class="btn btn-secondary btn-small">Reload</button>
                    </div>
                </div>
                <textarea id="candidateEditor" class="code-editor" spellcheck="false"
                          placeholder="Loading..."></textarea>
                <p id="candidateStatus" class="editor-status"></p>
            </div>
        </section>

        <!-- System Prompt Tab -->
        <section id="tab-prompt" class="tab-panel">
            <div class="editor-card">
                <div class="editor-header">
                    <h2>cv-gen-system-prompt.txt</h2>
                    <div class="editor-actions">
                        <button id="savePromptBtn" class="btn btn-primary btn-small">Save</button>
                        <button id="reloadPromptBtn" class="btn btn-secondary btn-small">Reload</button>
                    </div>
                </div>
                <textarea id="promptEditor" class="code-editor" spellcheck="false"
                          placeholder="Loading..."></textarea>
                <p id="promptStatus" class="editor-status"></p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Created by <strong th:text="${candidateName}">Pranav Ghorpade</strong></p>
            <p>Files are saved to the <code>./data/</code> directory</p>
        </footer>
    </div>

    <script th:src="@{/js/app.js}"></script>
    <script>
        // ---- Tab switching ----
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // ---- Helpers ----
        function setStatus(el, msg, type) {
            el.textContent = msg;
            el.className = 'editor-status editor-status-' + type;
            if (type === 'success') setTimeout(() => { el.textContent = ''; }, 4000);
        }

        // ---- Candidate Data ----
        const candidateEditor = document.getElementById('candidateEditor');
        const candidateStatus = document.getElementById('candidateStatus');

        async function loadCandidateData() {
            try {
                const res = await fetch('/api/profile/candidate-data');
                candidateEditor.value = await res.text();
            } catch (e) {
                setStatus(candidateStatus, 'Failed to load: ' + e.message, 'error');
            }
        }

        document.getElementById('saveCandidateBtn').addEventListener('click', async () => {
            try {
                // Quick JSON syntax check
                JSON.parse(candidateEditor.value);
            } catch (e) {
                setStatus(candidateStatus, 'Invalid JSON: ' + e.message, 'error');
                return;
            }
            try {
                const res = await fetch('/api/profile/candidate-data', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: candidateEditor.value
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    setStatus(candidateStatus, 'Saved! Profile reloaded for: ' + data.name, 'success');
                } else {
                    setStatus(candidateStatus, 'Error: ' + data.message, 'error');
                }
            } catch (e) {
                setStatus(candidateStatus, 'Save failed: ' + e.message, 'error');
            }
        });

        document.getElementById('reloadCandidateBtn').addEventListener('click', loadCandidateData);

        // ---- System Prompt ----
        const promptEditor = document.getElementById('promptEditor');
        const promptStatus = document.getElementById('promptStatus');

        async function loadSystemPrompt() {
            try {
                const res = await fetch('/api/profile/system-prompt');
                promptEditor.value = await res.text();
            } catch (e) {
                setStatus(promptStatus, 'Failed to load: ' + e.message, 'error');
            }
        }

        document.getElementById('savePromptBtn').addEventListener('click', async () => {
            try {
                const res = await fetch('/api/profile/system-prompt', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'text/plain' },
                    body: promptEditor.value
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    setStatus(promptStatus, 'Saved! System prompt reloaded.', 'success');
                } else {
                    setStatus(promptStatus, 'Error: ' + data.message, 'error');
                }
            } catch (e) {
                setStatus(promptStatus, 'Save failed: ' + e.message, 'error');
            }
        });

        document.getElementById('reloadPromptBtn').addEventListener('click', loadSystemPrompt);

        // ---- Init ----
        loadCandidateData();
        loadSystemPrompt();
    </script>
</body>
</html>
